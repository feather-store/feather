name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pybind11 numpy build twine
    
    - name: Build C++ core
      run: |
        g++ -O3 -std=c++17 -fPIC -c src/feather_core.cpp -o feather_core.o
        ar rcs libfeather.a feather_core.o
    
    - name: Build Python bindings
      run: |
        python setup.py build_ext --inplace
    
    - name: Test import
      run: |
        python -c "import feather_py; print('✓ Import successful')"
    
    - name: Run basic tests
      run: |
        python << 'EOF'
        import feather_py
        import numpy as np
        db = feather_py.DB.open("test.feather", 128)
        vec = np.random.random(128).astype(np.float32)
        db.add(1, vec)
        ids, dists = db.search(vec, 1)
        assert ids[0] == 1
        print("✓ Basic test passed")
        import os
        os.remove("test.feather")
        EOF
